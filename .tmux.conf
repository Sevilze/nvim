# Set the prefix to Ctrl-Space
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# Enable mouse support
set -g mouse on

# Start window numbering at 1
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when a window is closed
set -g renumber-windows on

# Change window navigation to use window index
unbind n  # unbind default next-window binding
unbind p  # unbind default previous-window binding
bind i choose-window  # bind window index navigation to Ctrl+Space i

# Increase scrollback buffer size
set -g history-limit 10000

# Set terminal color to 256 colors
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",*256col*:Tc"

# Improve colors
set -g status-style 'bg=#333333 fg=#5eacd3'

# Set status bar
set -g status-position top
set -g status-left-length 20
set -g status-left '#{?client_prefix,#[fg=colour254]#[bg=colour31]#[bold] TMUX #[fg=colour31]#[bg=colour234]#[nobold],#[fg=colour16]#[bg=colour254]#[bold] TMUX #[fg=colour254]#[bg=colour234]#[nobold]}'
set -g status-right '#[fg=#5eacd3]%H:%M #[fg=#5eacd3]%d-%b-%y'
set -g window-status-current-format "#[fg=black,bg=#5eacd3] #I:#W "
set -g window-status-format "#[fg=#5eacd3] #I:#W "

# Vim-like pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Split panes using | and -
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Create new window with current path
bind c new-window -c "#{pane_current_path}"

# Reload config file
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Fast pane switching
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Resize panes with Prefix + arrow keys
bind -r Left resize-pane -L 5
bind -r Down resize-pane -D 5
bind -r Up resize-pane -U 5
bind -r Right resize-pane -R 5

# Vim-like copy mode
setw -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind P paste-buffer
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"

# Smart pane switching with awareness of Vim splits
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind -n C-h if-shell "$is_vim" "send-keys C-h"  "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j"  "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k"  "select-pane -U"
bind -n C-l if-shell "$is_vim" "send-keys C-l"  "select-pane -R"
bind -n C-\\ if-shell "$is_vim" "send-keys C-\\" "select-pane -l"

# Enable focus events (for Vim autoread)
set -g focus-events on

# Reduce escape-time (helps with Vim)
set -sg escape-time 10

# Remove any conflicting bindings first
unbind-key -T prefix &
unbind-key -T prefix x

# Clean Neovim swap files and save Harpoon state before killing a window/pane
bind-key & run-shell "$HOME/.config/nvim/scripts/clean_swap_files.sh && cd $HOME/.config/nvim && bash scripts/save_nvim_state.sh" \; confirm-before -p "kill-window #W? (y/n)" kill-window
bind-key x run-shell "$HOME/.config/nvim/scripts/clean_swap_files.sh && cd $HOME/.config/nvim && bash scripts/save_nvim_state.sh" \; confirm-before -p "kill-pane #P? (y/n)" kill-pane

# Add a direct command to manually save Harpoon state with visible feedback in CLI
bind-key H run-shell "cd $HOME/.config/nvim && bash scripts/save_nvim_state.sh"

# Add a command to reload Harpoon state with visible feedback in CLI
bind-key R run-shell "tmux send-keys Escape \":HarpoonReload\" Enter && echo \"Reloading Harpoon state...\""

# Add a key binding to manually clean swap files
bind-key C run-shell "$HOME/.config/nvim/scripts/clean_swap_files.sh"

# Add a key binding to clean up Harpoon files
bind-key M run-shell "cd $HOME/.config/nvim && bash scripts/cleanup_harpoon.sh"

# Add a key binding to manually install TPM and plugins
bind-key I run-shell "if test ! -d ~/.tmux/plugins/tpm; then git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm; fi && ~/.tmux/plugins/tpm/bin/install_plugins && tmux display-message 'Plugins installed!'"

# Initialize TMUX plugin manager if it exists
if-shell "test -f ~/.tmux/plugins/tpm/tpm" "run '~/.tmux/plugins/tpm/tpm'"
